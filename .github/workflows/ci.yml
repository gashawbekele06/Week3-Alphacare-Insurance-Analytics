name: DVC Reproducibility Check

# Triggers the workflow on push events to main or task-2 branch
on:
  push:
    branches:
      - main
      - task-2

jobs:
  reproducibility:
    runs-on: ubuntu-latest

    # Define environment variables used for DVC authentication
    env:
      # This variable holds the base64 encoded JSON key for the Google Drive Service Account
      GDRIVE_SERVICE_ACCOUNT_KEY: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_KEY }}
      # Define the path where the key will be written in the runner's environment
      GDRIVE_KEY_PATH: gdrive_key.json
      # Define the name of your DVC remote
      DVC_REMOTE_NAME: storage

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          # Necessary for DVC to work correctly with Git history
          fetch-depth: 0

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ðŸ“¦ Install DVC and Dependencies
        run: |
          # Install DVC with Google Drive support
          pip install "dvc[gdrive]"
          # Install other project dependencies (if you have a requirements.txt)
          pip install -r requirements.txt

      - name: ðŸ”‘ Configure Google Drive Service Account
        # This step uses the secret stored in GitHub to create the JSON file locally
        run: |
          echo "Writing service account key to file: $GDRIVE_KEY_PATH"
          # Write the base64 decoded secret to a file. 
          # The key must be stored in GitHub Secrets.
          echo $GDRIVE_SERVICE_ACCOUNT_KEY | base64 -d > $GDRIVE_KEY_PATH

          # Check if the DVC remote exists before modifying
          if dvc remote list | grep -q "$DVC_REMOTE_NAME"; then
              echo "Configuring service account path for remote: $DVC_REMOTE_NAME"
              # Modify the DVC config to point to the newly created key file
              dvc remote modify $DVC_REMOTE_NAME gdrive_service_account_path $GDRIVE_KEY_PATH
          else
              echo "Error: DVC remote '$DVC_REMOTE_NAME' not found."
              exit 1
          fi

      - name: ðŸ”„ Pull DVC Data and Models
        run: |
          echo "Attempting to pull data and models from DVC remote..."
          # Pull all necessary data/models defined in the .dvc files
          dvc pull

      - name: ðŸ§ª Run Data Pipeline (Reproducibility Check)
        run: |
          echo "Running the full data processing pipeline..."
          # Replace 'python run_pipeline.py' with the actual command to run your data pipeline
          # This verifies that the code and the pulled data/models can successfully reproduce the results.
          python src/run_pipeline.py

      - name: âœ… Check for Uncommitted Changes
        # This step ensures that running the pipeline did not unexpectedly modify any tracked files.
        run: |
          echo "Checking DVC and Git status..."
          dvc status --quiet || (echo "DVC tracked files were modified during the pipeline run!" && exit 1)
          git diff --exit-code || (echo "Code or DVC meta-files were modified after pipeline run!" && exit 1)

      - name: ðŸ§¹ Clean up Service Account Key
        # Always remove sensitive files
        if: always()
        run: |
          rm -f $GDRIVE_KEY_PATH
